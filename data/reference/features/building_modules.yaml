article:
  title: モジュールの構築
  content:
    - |
      以前に簡単に触れたモジュールの構築方法について、ここで詳しく解説します。

      すでに述べた通り、モジュールを構築するにはモジュール定義を記述します。以下の説明では、ModDL で記述したモジュール定義と、そこから生成されるモジュールの構造とを併せて示していきます。

      ## ノードの生成

      単独のノードを生成するには、モジュール定義の一種である**ノード定義**を使います。

      たとえば、ノード定義の一種である `sineOsc` を記述すると、正弦波のオシレータが生成されます。

      ```
      sineOsc
      ```

      <img src="./sineOsc.png" width=50%>

      ノードの種類によっては、パラメータ入力を受け付けるものがあります。たとえばノード定義 `lpf` から生成されるノード（以下、簡単に「`lpf` のノード」などと言うことにします）は、パラメータ入力として `freq` と `q` を受け付けるようになっています。これらに値を設定するには次のように記述します：

      ```
      lpf { freq: 8000, q: 10 }
      ```

      <img src="./lpf1.png" width=50%>

      `lpf` ではこれらのパラメータは必須であり、指定しないとエラーになります。たとえば次のような記述はエラーになります：

      ```
      // 全てエラー
      lpf
      lpf { freq: 8000 }
      lpf { q: 10 }
      ```

      一方、パラメータを省略できるノードもあります。たとえば `adsrEnv` のノードは 5 つのパラメータ入力 `attack`, `decay`, `sustain`, `release`, `initial` を取りますが、これらは全て省略することができます。省略した場合、それぞれのデフォルト値である `0`, `0`, `1`, `0`, `1` が補われます。

      ```
      adsrEnv
      ```

      <img src="./adsrEnv1.png" width=50%>

      一部のパラメータだけを指定することもできます：

      ```
      adsrEnv { initial: 0.5, attack: 1.5 }
      ```

      <img src="./adsrEnv2.png" width=50%>

      <!-- TODO この辺の説明、data\reference\data_types_and_value_notations.yaml とかぶっている。要整理 -->

      ## ノードの接続

      あるノードの出力を別のノードの入力に接続する方法を解説します。接続する先の入力が主入力かパラメータ入力かによって、記述のしかたが異なります。

      パラメータ入力の場合は、これまで見てきた通りです：

      ```
      lpf { freq: 8000, q: 10 }
      ```

      <img src="./lpf1.png" width=50%>

      このとき、定数 `8000` を出力するノードが `lpf` のパラメータ入力 `freq` に、`10` を出力するノードが `q` に、それぞれ接続されています。

    - note:
      - |
        `8000` や `10` は数値ですが、ノード定義の入力として使われているため「数値を出力するノードの定義」として解釈されます。

    - |
      これに対して主入力の場合は、ノード定義同士を `|` 演算子で連結します。先ほどの `lpf` に `sawOsc` の出力を入力するには次のようにします：

      ```
      sawOsc | lpf { freq: 8000, q: 10 }
      ```

      <img src="./sawOsc-lpf.png" width=50%>

      ## 数値演算

      ノードの出力に対して数値演算を行うこともできます。

      ノード定義に対して演算子を適用すると、演算子は「ノードの出力に対して演算を行うノードの定義」として解釈されます。このとき、演算の相手が数値であれば、こちらも「数値を出力するノードの定義」と解釈されます。

      ```
      sineOsc + 1
      ```

      <img src="./calc1.png" width=50%>

    - note:
      - |
        両方とも数値の場合は数値のまま計算され、ノード定義にはなりません。

        ```
        // 3 と等価
        2 + 1
        ```

    # TODO ここまでパラメータ入力は定数だけで、複雑にしたものがなかったので何か紹介したいが、うまく入りそうなところがないな
    # - |
    #   ```
    #   sawOsc | lpf { freq: 4000 + 2000 * 5 | sineOsc, q: 10 }
    #   ```
    
    # エンベロープを * で適用するサンプルを入れたい（他のところでも書けるかも？）

    - note:
      - |
        `|` 演算子は四則演算などの演算子よりも優先度が高いことに注意してください（多くの言語におけるビット演算の `|` 演算子とは異なります）。

        減算合成シンセサイザの基本的な構造である `vco | vcf * vca` を括弧なしで書けるようになっています。

    - |
      ## 入力参照

      あるモジュールに入力されてくる値を、数値演算などの対象として明示的に扱いたい場合があります。

# たとえば、オシレータは主入力として周波数を取りますが、この周波数を加工してからオシレータに入力したいような場合です。

# ```

